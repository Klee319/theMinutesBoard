# 不具合修正レポート 2025-01-15

## 不具合・エラーの概要
1. 開始時刻・経過時間の表示が誤っている
2. ネクストステップの期限設定が機能していない（明日・明後日のキーワードだけでなく、具体的な日付でも未設定になる）

## STEP0. ゴール地点の確認
- 開始時刻と経過時間を正確に表示する
- ネクストステップの期限設定が、相対日付（明日・明後日など）と絶対日付（具体的な日付）の両方で機能する

## STEP1. 不具合発生箇所の調査

### 1. 開始時刻・経過時間の表示問題
- **services/ai/base.ts** (155行目): `toLocaleString`で開始時刻を出力
- **popup/App.tsx** (204行目): 経過時間の計算処理
- **LiveMinutesPanel/index.tsx** (157行目): 開始時刻をHH:MM形式でパース
- **system-prompts/live-minutes-generation.md**: `{{startTime}}`テンプレート使用

### 2. ネクストステップの期限設定問題
- **system-prompts/nextsteps-generation.md**: 期限設定ルールは明確に定義されている
- **services/ai/base.ts** (400-404行目): `meetingDate`の設定処理
- AIプロンプトで`{{meetingDate}}`が正しく渡されていない可能性

## STEP2. 原因の調査

### 1. 開始時刻・経過時間の問題の原因
- ライブ議事録生成時に`startTime`が時刻のみ(HH:MM)で表示される
- `meetingInfo?.startTime`が空の場合があり、その際のフォールバック処理が不十分
- `toLocaleTimeString`を使用している箇所があり、日付情報が失われる

### 2. ネクストステップの期限設定問題の原因
- `meetingDate`テンプレート変数が正しくAIプロンプトに渡されていない
- 日付計算のロジックはAI側に委ねられているが、基準日が正しく設定されていない

## STEP3. 修正案の検討

### 1. 開始時刻・経過時間の修正案
- `startTime`の表示を常に`toLocaleString`で統一（日付＋時刻）
- ライブ議事録生成時の時刻フォーマットを修正
- startTimeが空の場合のフォールバック処理を改善

### 2. ネクストステップの期限設定の修正案
- `meetingDate`を確実に日付形式で渡す
- デバッグログを追加して値を確認

## STEP4. 修正案の実装

### 実装した修正内容

#### 1. 開始時刻・経過時間の表示修正
- **services/ai/base.ts** (290行目): 
  - `meetingDate`をDateオブジェクトから日付文字列に変換
  - `safeFormatLocaleDateString`を使用して正しい日付形式にフォーマット
  
- **services/ai/base.ts** (413-414行目): 
  - ネクストステップ生成時のデバッグログを追加
  - `meetingDate`と`startTime`の値を確認

- **LiveMinutesPanel/index.tsx** (156-177行目):
  - 開始時刻のパース処理を改善
  - 完全な日時形式（YYYY/MM/DD HH:MM:SS）に対応
  - HH:MM形式の場合は今日の日付で設定するフォールバック処理

#### 2. ネクストステップの期限設定修正
- `meetingDate`がプロンプトに正しく日付文字列として渡されるように修正
- これにより、AIが相対日付（明日、来週など）や具体的な日付を正しく計算可能に

### 考察した原因
- `meetingDate`がDateオブジェクトのまま渡されていたため、AIが日付として認識できなかった
- 開始時刻が時刻のみ（HH:MM）で表示される場合があり、日付情報が失われていた

### 実際に修正した原因
- テンプレート変数の`meetingDate`をDateオブジェクトから日付文字列に変換
- 開始時刻のパース処理を改善し、完全な日時形式に対応